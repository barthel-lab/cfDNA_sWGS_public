import sys
import pysam
import re

def is_mouse_chrom(chrom):
    return bool(re.search(r'(_mm|\.)', chrom))

def is_human_chrom(chrom):
    return not is_mouse_chrom(chrom)

def check_ambiguous(xa_tag, primary_chrom):
    # Returns True if XA tag indicates cross-species alignment
    if is_human_chrom(primary_chrom) and re.search(r'chr.*_mm', xa_tag):
        return True
    if is_mouse_chrom(primary_chrom) and re.search(r'chr[^_]*[^.]($|[^_])', xa_tag):
        return True
    return False

def separate_reads(input_bam, out_hg, out_mm, out_amb):
    bam = pysam.AlignmentFile(input_bam, "rb")

    # Create output BAM files, with headers
    header = bam.header.to_dict()

    # Filter headers by chromosome type
    mm_hdr = {k: v for k, v in header.items()}
    hg_hdr = {k: v for k, v in header.items()}

    # Filter @SQ lines
    mm_hdr['SQ'] = [sq for sq in header['SQ'] if is_mouse_chrom(sq['SN'])]
    hg_hdr['SQ'] = [sq for sq in header['SQ'] if is_human_chrom(sq['SN'])]

    out_bam_mm = pysam.AlignmentFile(out_mm, "wb", header=mm_hdr)
    out_bam_hg = pysam.AlignmentFile(out_hg, "wb", header=hg_hdr)
    out_bam_amb = pysam.AlignmentFile(out_amb, "wb", header=header)  # Ambiguous get full header

    for read in bam.fetch(until_eof=True):

        # Skip secondary/supplementary alignments
        if read.is_secondary or read.is_supplementary:
            continue

        primary_chrom = read.reference_name
        mate_chrom = None
        if read.is_paired and not read.mate_is_unmapped:
            mate_chrom = bam.getrname(read.next_reference_id) if read.next_reference_id >= 0 else None

        # Check XA tag (optional)
        xa_tag = None
        if read.has_tag('XA'):
            xa_tag = read.get_tag('XA')

        # Ambiguous: if XA tag indicates cross-species
        if xa_tag and check_ambiguous(xa_tag, primary_chrom):
            out_bam_amb.write(read)
            continue

        # Confident mouse: both read and mate chrom are mouse or mate chrom '=' (None)
        if is_mouse_chrom(primary_chrom) and (mate_chrom is None or is_mouse_chrom(mate_chrom)):
            out_bam_mm.write(read)
            continue

        # Confident human: both read and mate chrom are human or mate chrom '=' (None)
        if is_human_chrom(primary_chrom) and (mate_chrom is None or is_human_chrom(mate_chrom)):
            out_bam_hg.write(read)
            continue

        # Otherwise ambiguous
        out_bam_amb.write(read)

    bam.close()
    out_bam_mm.close()
    out_bam_hg.close()
    out_bam_amb.close()

if __name__ == "__main__":
    if len(sys.argv) != 5:
        print("Usage: python separate_reads.py input.bam output_hg.bam output_mm.bam output_amb.bam")
        sys.exit(1)
    separate_reads(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
